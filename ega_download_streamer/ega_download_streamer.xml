<tool id="ega_download_streamer" name="EGA Download streamer" version="2.1.3.g0">
    <description>data from the European Genome-phenome Archive in a secure manner</description>
    <requirements>
        <requirement type="package" version="2.1.6">EGA_download_streamer</requirement>
    </requirements>
    <stdio>
        <!-- Anything other than zero is an error -->
        <regex match="Login failed" source="both" level="fatal"/>
        <exit_code range="1:" />
        <exit_code range=":-1" />
    </stdio>
    <version_command>java -jar $EGA_DOWNLOAD_STREAMER_ROOT_DIR/jars/EgaDemoClient.jar -version | grep -i Version | grep -v -i new</version_command>
    <command><![CDATA[
        #import random
        #import string
        
        #set $encryption_key = ''.join(random.SystemRandom().choice(string.ascii_uppercase + string.ascii_lowercase + string.digits) for _ in range(2048))
        #set $random_request_uid = 'request_'+str($ega_file_identifier)+'_'+''.join(random.SystemRandom().choice(string.ascii_uppercase + string.ascii_lowercase + string.digits) for _ in range(64))
        
        echo \$user > credentials.txt &&
        echo \$pass >> credentials.txt &&
        
        echo "Creating an encryption request at server" && 
        java -jar
            "\$EGA_DOWNLOAD_STREAMER_ROOT_DIR/jars/EgaDemoClient.jar"
            -pf "credentials.txt"
            -rf "$ega_file_identifier"
            -re "$encryption_key"
            -label "${random_request_uid}" | grep -v "Login failed" && 
        
        echo "\n\n\nDownloading request" && 
        java -jar
            "\$EGA_DOWNLOAD_STREAMER_ROOT_DIR/jars/EgaDemoClient.jar"
            -pf "credentials.txt"
            -dr "${random_request_uid}"
            -nt 7 > download.log && 
        
        cat download.log &&
         
        ## Commands below may fail if authentication was not a success
        ENCRYPTED_FILES_NAME=\$(grep -oE "Completed Download Target:[ ]+(.*?)\.cip" download.log | sed -r "s/^Completed Download Target:[ ]+//" ) && 
        DECRYPTED_FILES_NAME=\${ENCRYPTED_FILES_NAME%.cip} && 
        
        echo "\n\n\n Decrpyting \$ENCRYPTED_FILES_NAME to \$DECRYPTED_FILES_NAME" && 
        ls &&
        java -jar
            "\$EGA_DOWNLOAD_STREAMER_ROOT_DIR/jars/EgaDemoClient.jar"
            -pf credentials.txt
            -dc "\$ENCRYPTED_FILES_NAME"
            -dck "$encryption_key" &&
        
        ls &&
        if file --mime-type "\$DECRYPTED_FILES_NAME" | grep -q /gzip$; then
            echo "Unzipping as well" &&
            gunzip -cf "\$DECRYPTED_FILES_NAME" > "$output" ;
        else
            echo "File format is: "\$(file --mime-type "\$DECRYPTED_FILES_NAME") &&
            mv "\$DECRYPTED_FILES_NAME" "$output" ;
        fi ;
        
        echo "Cleaning up credentials" && 
        echo "overwriten" > "credentials.txt" && 
        rm "credentials.txt"
    ]]></command>
    <inputs>
        <param name="ega_file_identifier" type="text" value="" label="Identifier of the file in EGA" />
        <!--
        @todo santize for non alplhanumerical stuff
        
        EGAF00001059069
        -->
    </inputs>
    <outputs>
        <data name="output" auto_format="true" label="${tool.name} on ${ega_file_identifier}" />
    </outputs>
    <tests>
        <!-- EGAF00001059069 -->
    </tests>
    
    <help>
Make sure environment variables $user and $pass are exported.
This is a serious security issue and is not user friendly.
The admin should set up a generic account in the config/jobs_conf.xml by settings these variables correctly.
    </help>
    
    <citations>
    </citations>
</tool>
