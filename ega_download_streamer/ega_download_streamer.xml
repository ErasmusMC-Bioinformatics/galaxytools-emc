<tool id="ega_download_streamer" name="EGA Download streamer" version="2.1.3.g0">
    <description>data from the European Genome-phenome Archive in a secure manner</description>
    <requirements>
        <requirement type="package" version="2.1.1">EGA_download_streamer</requirement>
    </requirements>
    <stdio>
        <!-- Anything other than zero is an error -->
        <regex match="Login failed" source="both" level="fatal"/>
        <exit_code range="1:" />
        <exit_code range=":-1" />
    </stdio>
    <version_command>java -jar $EGA_DOWNLOAD_STREAMER_ROOT_DIR/jars/EgaDemoClient.jar -version | grep -i Version | grep -v -i new</version_command>
    <command><![CDATA[
        #import random
        #import string
        
        #set $encryption_key = ''.join(random.SystemRandom().choice(string.ascii_uppercase + string.ascii_lowercase + string.digits) for _ in range(2048))
        
        echo \$user > credentials.txt &&
        echo \$pass >> credentials.txt &&
        
        echo "Creating an encryption request at server" && 
        java -jar
            "\$EGA_DOWNLOAD_STREAMER_ROOT_DIR/jars/EgaDemoClient.jar"
            -pf "credentials.txt"
            -rf "$ega_file_identifier"
            -re "$encryption_key"
            -label "request_$ega_file_identifier" | grep -v "Login failed" && 
        
        echo "\n\n\nDownloading request" && 
        java -jar
            "\$EGA_DOWNLOAD_STREAMER_ROOT_DIR/jars/EgaDemoClient.jar"
            -pf "credentials.txt"
            -dr "request_$ega_file_identifier"
            -nt 7 > download.log && 
        
        cat download.log &&
         
        ## Commands below may fail if authentication was not a success
        ENCRYPTED_FILES_NAME=\$(grep -oE "Completed Download: .*?\.gpg (.*?)\.cip" download.log | cut -f 5 -d " ") && 
        DECRYPTED_FILES_NAME=\${ENCRYPTED_FILES_NAME%.cip} && 
        
        echo "\n\n\n Decrpyting \$ENCRYPTED_FILES_NAME" && 
        java -jar
            "\$EGA_DOWNLOAD_STREAMER_ROOT_DIR/jars/EgaDemoClient.jar"
            -pf credentials.txt
            -dc "\$ENCRYPTED_FILES_NAME"
            -dck $encryption_key &&
        
        if file --mime-type "\$DECRYPTED_FILES_NAME" | grep -q /gzip$; then
            gunzip -cf "\$DECRYPTED_FILES_NAME" > "$output" ;
        else
            mv "\$DECRYPTED_FILES_NAME" "$output" ;
        fi ;
        
        echo "Cleaning up credentials" && 
        echo "overwriten" > "credentials.txt" && 
        rm "credentials.txt"
        
    ]]></command>
    <inputs>
        <param name="ega_file_identifier" type="text" value="" label="Identifier of the file in EGA" />
        <!--
        @todo santize for non alplhanumerical stuff
        
        EGAF00000662831
        -->
    </inputs>
    <outputs>
        <data name="output" auto_format="true" label="${tool.name} on ${ega_file_identifier}" />
        <!-- <data name="output" format="auto"/> -->
    </outputs>
    <tests>
    </tests>
    
    <help>
        Make sure environment variables $user and $pass are exported. This is a serious security issue and is not user friendly.
    </help>
    
    <citations>
    </citations>
</tool>
