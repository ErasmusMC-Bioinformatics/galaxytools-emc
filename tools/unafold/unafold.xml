<?xml version="1.0"?>
<tool id="unafold" name="UNAFold" version="1.1.0">
    <description>UNAFold RNA and DNA structure prediction</description>

    <requirements>
        <requirement type="package" version="3.8">unafold</requirement>
    </requirements>

    <stdio>
        <regex match="mv: cannot stat ..: No such file or directory" source="stderr" level="fatal" description="Could not find CT output file\n" />
    </stdio>

    <version_command>UNAFold.pl --version</version_command>

    <command><![CDATA[
        #if str($input_source.select_fasta) == "false"
            echo ">Sequence"                      >  "input.fasta" &&
            echo "${input_source.input_sequence}" >> "input.fasta" &&
        #end if
        
        UNAFold.pl
            -n $n.a
            -t $temp
            #if $n.a == "DNA"
                -N $sodium
                -M $magnesium
            #end if
            
            #if str($input_source.select_fasta) == "false"
                "input.fasta"
            #else
                "${input_source.input_file}"
            #end if
            &&
        
        output=\$(ls | grep \.ct | sort -r | head -n 1) &&
        
        mv "\$output" "$output_ct"
    ]]></command>

    <inputs>
        <conditional name="input_source">
            <param name="select_fasta" type="boolean" truevalue="true" falsevalue="false" label="Input from FASTA file" selected="false" />
            
            <when value="true">
                <param format="fasta" name="input_file" type="data" label="Input sequence (FASTA)"/>
            </when>
            <when value="false">
                <param name="input_sequence" type="text" label="Input sequence"/>
            </when>
        </conditional>
    
        <conditional name="n">
            <param name="a" type="select" label="Nucleic Acid Type">
                <option value="RNA" selected="true">RNA</option>
                <option value="DNA">DNA</option>
            </param>
            
            <when value="RNA">
            </when>
            <when value="DNA">
                <param name="sodium" type="float" size="6" value="1.0" min="0" max="100" label="[Na+] in M"/>
                <param name="magnesium" type="float" size="6" value="0.0" min="0" max="100" label="[Mg++] in M"/>
            </when>
        </conditional>
        
        <param name="temp" type="integer" size="3" value="37" min="0" max="100" label="Temperature (&#176;C)"/>
    </inputs>

    <outputs>
        <data format="ct" name="output_ct" label="${tool.name}"/>
    </outputs>

    <tests>
        <test>
            <param name="select_fasta" value="true" />
            <param name="input_file" value="test1_input.fa" ftype="fasta" />
            <param name="temp" value="37" />
            
            <output name="output_ct" file="test1_output.ct" />
        </test>
        <test>
            <param name="select_fasta" value="false" />
            <param name="input_sequence" value="GGGGGaaaCCCCC" />
            <param name="temp" value="37" />
            
            <output name="output_ct" file="test1_output.ct" lines_diff="2" /><!-- Sequence name (header) differs -->
        </test>
    </tests>

    <help><![CDATA[
``Usage: UNAFold.pl [options] file [file]``

``Options:``
``-V, --version``

``-h, --help``

``-n, --NA=(RNA | DNA) (defaults to RNA)``

``-t, --temp=<temperature> (defaults to 37)``

``-N, --sodium=<[Na+] in M> (defaults to 1)``

``-M, --magnesium=<[Mg++] in M> (defaults to 0)``

``-p, --polymer``

``-C, --Ct=<total strand concentration>``

``-I, --noisolate``

``-m, --maxbp=<maximum basepair distance>``

``-c, --constraints=<name of constraints file> (defaults to prefix.aux)``

``-P, --percent=<energy increment percent> (defaults to 5)``

``-W, --window=<window size> (default set by sequence length)``

``-X, --max=<maximum number of foldings> (defaults to 100)``

``--ann=(none | p-num | ss-count) (defaults to none)``

``--mode=(auto | bases | lines) (defaults to auto)``

``--label=<base numbering frequency>``

``--rotate=<structure rotation angle>``

``--run-type=(text | html) (defaults to text)``

``--model=(EM | PF) (defaults to EM)``

``--circular``

``Obscure options:``

``--allpairs``

``--maxloop=<maximum bulge/interior loop size> (defaults to 30)``

``--nodangle``

``--simple``

``--prefilter=<filter value>``
    ]]></help>

    <citations>
        <citation type="doi">10.1007/978-1-60327-429-6_1</citation>
    </citations>
</tool>
